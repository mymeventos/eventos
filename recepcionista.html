<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Invitados - Salón M&M</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        /* Estilos para el contenedor del escáner QR */
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Limita el ancho para pantallas grandes */
            margin: 20px auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #qr-reader__dashboard {
            padding: 10px;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
        }
        #qr-reader__scan_region {
            min-height: 200px; /* Asegura que la cámara tenga espacio */
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }
        /* Mensaje de advertencia para HTTPS */
        #https-warning {
            display: none; /* Oculto por defecto */
            background-color: #fff3cd;
            border-color: #ffecb5;
            color: #664d03;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        /* Estilos para el mensaje de feedback de escaneo (pequeño, en la parte superior) */
        #scan-feedback-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #scan-feedback-message.show {
            opacity: 1;
        }
        #scan-feedback-message.success {
            background-color: #10b981; /* green-500 */
        }
        #scan-feedback-message.info {
            background-color: #3b82f6; /* blue-500 */
        }
        #scan-feedback-message.error {
            background-color: #ef4444; /* red-500 */
        }

        /* NUEVOS ESTILOS PARA EL FEEDBACK EN PANTALLA COMPLETA */
        #full-screen-feedback {
            background-color: #10b981; /* Default green for success */
            opacity: 0;
            pointer-events: none; /* Allow clicks to pass through when hidden */
            transition: opacity 0.3s ease-in-out;
            display: flex; /* Para centrar el contenido */
            align-items: center;
            justify-content: center;
            flex-direction: column; /* Para apilar nombre y mesa */
            font-size: 3rem; /* Tamaño de fuente grande */
            font-weight: bold;
            color: white;
            padding: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); /* Sombra para mejor legibilidad */
        }
        #full-screen-feedback.show {
            opacity: 1;
            pointer-events: auto; /* Block clicks when visible */
        }
        #full-screen-feedback.info {
            background-color: #3b82f6; /* Blue for info */
        }
        #full-screen-feedback.error {
            background-color: #ef4444; /* Red for error */
        }
        #full-screen-feedback #full-screen-content {
            line-height: 1.2; /* Espaciado entre líneas */
        }
        #full-screen-feedback #full-screen-content span {
            display: block; /* Cada línea en su propio bloque */
            font-size: 0.7em; /* Mesa un poco más pequeña */
            margin-top: 5px;
        }

        /* Estilos para el botón de eliminar invitado añadido */
        .delete-guest-btn {
            background: none;
            border: none;
            color: #ef4444; /* red-500 */
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            transition: color 0.2s ease;
        }
        .delete-guest-btn:hover {
            color: #b91c1c; /* red-700 */
        }
    </style>
</head>
<body class="bg-gray-200">

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-gray-800">Recepción de Invitados</h1>
            <p id="event-name-header" class="text-lg text-indigo-600 font-semibold mt-1">&nbsp;</p>
        </header>

        <div id="https-warning" role="alert">
            <p>⚠️ **Advertencia:** Para que la cámara funcione, esta página debe ser accedida a través de **HTTPS** (conexión segura) o un dominio local seguro. Actualmente estás usando: <span id="current-protocol"></span></p>
            <p class="mt-2 text-sm">Si estás ejecutando el archivo localmente, considera usar un servidor web local con HTTPS o subirlo a un servicio de hosting seguro.</p>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
            <h2 class="text-2xl font-semibold mb-3 text-center">Escanear Código QR</h2>
            <div id="qr-reader"></div>
            <div id="qr-reader-results" class="text-center mt-4 text-gray-700 font-medium"></div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="start-scan-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-transform transform hover:scale-105">
                    Iniciar Escáner
                </button>
                <button id="stop-scan-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-transform transform hover:scale-105 hidden">
                    Detener Escáner
                </button>
            </div>
        </div>

        <div class="sticky top-0 bg-gray-200 py-4 z-10">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Buscar invitado..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-full shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4 px-2 text-sm">
                 <p class="text-gray-700 font-semibold">Total: <span id="total-guests">0</span></p>
                 <p class="font-semibold text-green-600">Presentes: <span id="present-guests">0</span></p>
                 <p class="font-semibold text-red-600">Ausentes: <span id="absent-guests">0</span></p>
                 <p class="font-semibold text-blue-600">Agregados: <span id="added-guests-count">0</span></p> </div>
        </div>

        <main id="guest-list-container" class="mt-2 space-y-3 pb-4"> <div id="loading-state-recepcion" class="text-center py-20 text-gray-500">
                <p>Cargando lista...</p>
            </div>
             <div id="no-results-state" class="hidden text-center py-20 text-gray-500">
                <p>No se encontraron invitados con ese nombre.</p>
            </div>
            <div id="empty-state-recepcion" class="hidden text-center py-20 text-gray-500">
                <p>No hay invitados registrados para este evento.</p>
                <p class="text-sm mt-2">Asegúrate de haber añadido invitados desde el panel de administración.</p>
            </div>
        </main>

        <div class="bg-white p-4 rounded-xl shadow-lg mt-6">
            <h2 class="text-2xl font-semibold mb-3 text-center">Agregar Invitado No Listado</h2>
            <div class="flex flex-col sm:flex-row gap-2 mb-4 items-center">
                <input type="text" id="new-guest-name" placeholder="Nombre y Apellido del invitado" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                <button id="add-guest-before-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-transform transform hover:scale-105 whitespace-nowrap">
                    Antes 00:00
                </button>
                <button id="add-guest-after-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-transform transform hover:scale-105 whitespace-nowrap">
                    Después 00:00
                </button>
            </div>
            <h3 class="text-xl font-semibold mb-2 text-gray-700">Invitados Añadidos (<span id="added-guests-count">0</span>):</h3>
            <div id="added-guests-list" class="space-y-2 mt-2">
                <div id="empty-added-guests-state" class="text-center py-4 text-gray-500 text-sm">
                    <p>No se han añadido invitados extra aún.</p>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="selector_de_eventos.html" class="text-indigo-600 hover:text-indigo-800 font-medium">← Volver al Panel de Eventos</a>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg id="modal-icon" class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500" id="modal-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeMessageModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="scan-feedback-message" class="hidden"></div>

    <div id="full-screen-feedback" class="hidden fixed inset-0 z-[1001]">
        <div id="full-screen-content"></div>
    </div>


    <script type="module">
        console.log("Script recepcionista QR- Copy.html iniciado."); // Log al inicio del script
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, getDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuración de Firebase - ¡Asegúrate de que tu API Key esté aquí!
        // Si estás ejecutando en tu propia web, NO dejes apiKey en blanco.
        const firebaseConfig = {
            apiKey: "AIzaSyDtr9JCvgHriGZNfk1Exw-wl6zXGRrzawE", // <--- CLAVE DE API AÑADIDA/RECONFIRMADA AQUÍ
            authDomain: "salon-de-eventos-mm.firebaseapp.com",
            projectId: "salon-de-eventos-mm",
            storageBucket: "salon-de-eventos-mm.firebasestorage.app",
            messagingSenderId: "1026723246426",
            appId: "1:1026723246426:web:518abd5aecd6e279bc0363",
            measurementId: "G-6QHQ0GDS25"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let guestsCollection;
        let eventId;
        let allGuests = []; // Almacena todos los invitados del evento
        let html5QrCode = null; // Instancia del escáner QR, inicializada a null
        let lastScannedGuestId = null; // Para evitar escaneos duplicados rápidos
        let scanFeedbackTimeout = null; // Timeout para el feedback de escaneo pequeño
        let fullScreenFeedbackTimeout = null; // Timeout para el feedback en pantalla completa
        let isScannerPausedForFeedback = false; // Flag para saber si el escáner está pausado por feedback

        // Inicializar un sintetizador de audio simple para feedback
        const synth = new Tone.Synth().toDestination();
        // Opcional: un sonido más complejo
        // const player = new Tone.Player("https://tonejs.github.io/audio/berklee/gong_1.mp3").toDestination(); // Requiere cargar un archivo de audio

        // Referencias a elementos del DOM
        const searchInput = document.getElementById('search-input');
        const guestListContainer = document.getElementById('guest-list-container');
        const totalGuestsEl = document.getElementById('total-guests');
        const presentGuestsEl = document.getElementById('present-guests');
        const absentGuestsEl = document.getElementById('absent-guests');
        const eventNameHeader = document.getElementById('event-name-header');
        const loadingState = document.getElementById('loading-state-recepcion');
        const noResultsState = document.getElementById('no-results-state');
        const emptyStateRecepcion = document.getElementById('empty-state-recepcion');
        const httpsWarning = document.getElementById('https-warning');
        const currentProtocolSpan = document.getElementById('current-protocol');

        // Elementos del escáner QR
        const qrReaderElement = document.getElementById('qr-reader');
        const qrReaderResultsElement = document.getElementById('qr-reader-results');
        const startScanBtn = document.getElementById('start-scan-btn');
        const stopScanBtn = document.getElementById('stop-scan-btn');

        // Elementos del modal de mensajes
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIcon = document.getElementById('modal-icon');

        // Elementos para el feedback de escaneo (pequeño y pantalla completa)
        const scanFeedbackMessageEl = document.getElementById('scan-feedback-message');
        const fullScreenFeedbackEl = document.getElementById('full-screen-feedback');
        const fullScreenContentEl = document.getElementById('full-screen-content');

        // Nuevos elementos para agregar invitados no listados
        const newGuestNameInput = document.getElementById('new-guest-name');
        const addGuestBeforeBtn = document.getElementById('add-guest-before-btn');
        const addGuestAfterBtn = document.getElementById('add-guest-after-btn');
        const addedGuestsList = document.getElementById('added-guests-list');
        const addedGuestsCountEl = document.getElementById('added-guests-count');
        const emptyAddedGuestsState = document.getElementById('empty-added-guests-state');


        // --- FUNCIONES DEL MODAL DE MENSAJES (para errores críticos de la app) ---
        function showMessageModal(title, message, type = 'info') {
            console.log(`Mostrando modal: Título="${title}", Mensaje="${message}", Tipo="${type}"`);
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modalIcon.innerHTML = ''; // Limpiar icono previo
            if (type === 'success') {
                modalIcon.classList.remove('bg-blue-100', 'bg-red-100', 'text-blue-600', 'text-red-600');
                modalIcon.classList.add('bg-green-100', 'text-green-600');
                modalIcon.innerHTML = `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else if (type === 'error') {
                modalIcon.classList.remove('bg-blue-100', 'bg-green-100', 'text-blue-600', 'text-green-600');
                modalIcon.classList.add('bg-red-100', 'text-red-600');
                modalIcon.innerHTML = `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else { // info
                modalIcon.classList.remove('bg-green-100', 'bg-red-100', 'text-green-600', 'text-red-600');
                modalIcon.classList.add('bg-blue-100', 'text-blue-600');
                modalIcon.innerHTML = `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }
            messageModal.classList.remove('hidden');
        }

        // Esta función es llamada por el onclick del botón "Cerrar" del modal
        function closeMessageModal() {
            console.log("Cerrando modal de mensajes.");
            messageModal.classList.add('hidden');
        }

        // --- FUNCIONES DE FEEDBACK DE ESCANEO (pequeño, temporal) ---
        function showScanFeedback(message, type = 'info') {
            console.log(`Feedback de escaneo (pequeño): Mensaje="${message}", Tipo="${type}"`);
            scanFeedbackMessageEl.textContent = message;
            scanFeedbackMessageEl.className = `scan-feedback-message show ${type}`;
            
            // Reproducir sonido solo si es un escaneo QR
            // La llamada a playFeedbackSound se ha movido a onScanSuccess
            
            // Ocultar el mensaje después de 5 segundos
            clearTimeout(scanFeedbackTimeout);
            scanFeedbackTimeout = setTimeout(() => {
                scanFeedbackMessageEl.classList.remove('show');
                scanFeedbackMessageEl.textContent = '';
                scanFeedbackMessageEl.className = 'scan-feedback-message';
            }, 5000); // Duración del cartel: 5 segundos
        }

        // --- NUEVAS FUNCIONES DE FEEDBACK EN PANTALLA COMPLETA ---
        async function displayFullScreenFeedback(message, type = 'success') {
            console.log(`Mostrando feedback en pantalla completa: Mensaje="${message}", Tipo="${type}"`);
            fullScreenContentEl.innerHTML = message;
            fullScreenFeedbackEl.className = `fixed inset-0 z-[1001] flex items-center justify-center text-white text-4xl font-bold text-center transition-opacity duration-300 show ${type}`;
            
            // Reproducir sonido
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    console.log("AudioContext reanudado para full-screen feedback.");
                    playFeedbackSound(type);
                } catch (e) {
                    console.error("Error al reanudar AudioContext para full-screen feedback:", e);
                }
            } else {
                playFeedbackSound(type);
            }

            // Ocultar el mensaje después de 3 segundos y reanudar escáner
            clearTimeout(fullScreenFeedbackTimeout);
            fullScreenFeedbackTimeout = setTimeout(() => {
                hideFullScreenFeedback();
            }, 3000); // Duración del cartel: 3 segundos
        }

        function hideFullScreenFeedback() {
            console.log("Ocultando feedback en pantalla completa.");
            fullScreenFeedbackEl.classList.remove('show');
            // Reanudar escáner solo si fue pausado por este feedback
            if (html5QrCode && isScannerPausedForFeedback) {
                html5QrCode.resume().then(() => {
                    console.log("Escáner reanudado después de feedback en pantalla completa.");
                    isScannerPausedForFeedback = false; // Resetear flag
                }).catch(err => {
                    console.error("Error al reanudar escáner después de feedback:", err);
                    // Si falla la reanudación, quizás mostrar un mensaje de error o intentar detener/reiniciar
                    showScanFeedback('Error al reanudar escáner. Por favor, detén y reinicia manualmente.', 'error');
                });
            }
        }

        function playFeedbackSound(type) {
            if (type === 'success') {
                synth.triggerAttackRelease("C4", "8n"); // Sonido de éxito
            }
            // Eliminar o comentar la línea para el sonido de error
            /* else if (type === 'error') {
                synth.triggerAttackRelease("C#2", "8n"); // Sonido de error
            } */
            else { // Incluye 'error' y 'info'
                synth.triggerAttackRelease("E4", "8n"); // Sonido de información o error
            }
        }

        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: Iniciando script de recepcionista.");
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('eventId');

            console.log("URL actual:", window.location.href);
            console.log("Protocolo actual:", window.location.protocol);
            currentProtocolSpan.textContent = window.location.protocol;

            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                httpsWarning.style.display = 'block';
                console.warn("ADVERTENCIA: La cámara puede no funcionar. La página no se está sirviendo a través de HTTPS.");
            } else {
                httpsWarning.style.display = 'none';
            }

            console.log("eventId obtenido de la URL:", eventId);

            if (!eventId) {
                console.error("Error: eventId no especificado. La URL no contiene el parámetro 'eventId'.");
                document.body.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-100">
                        <div class="text-center p-8 bg-white rounded-lg shadow-md">
                            <p class="text-xl font-semibold text-red-600 mb-4">Error: No se ha especificado un ID de evento.</p>
                            <p class="text-gray-700 mb-6">Por favor, accede a esta página desde el <a href="selector_de_eventos.html" class="text-indigo-600 hover:text-indigo-800 underline font-medium">Panel de Eventos</a>.</p>
                            <p class="text-sm text-gray-500">Así se asegura que el evento correcto sea cargado.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Inicializar la autenticación de Firebase
            onAuthStateChanged(auth, user => {
                if (user) {
                    console.log("onAuthStateChanged: Usuario autenticado:", user.uid);
                    setupPageForEvent();
                } else {
                    console.log("onAuthStateChanged: No hay usuario autenticado. Intentando autenticación anónima...");
                    signInAnonymously(auth).catch(error => {
                        console.error("onAuthStateChanged: Error en autenticación anónima:", error);
                        showMessageModal('Error de Autenticación', 'No se pudo iniciar sesión anónimamente. Por favor, recarga la página.', 'error');
                    });
                }
            }, (error) => {
                console.error("onAuthStateChanged: Error en el listener de autenticación:", error);
                showMessageModal('Error de Autenticación', 'Hubo un problema al verificar el estado de autenticación.', 'error');
            });
        });

        async function setupPageForEvent() {
            console.log("setupPageForEvent: Iniciando configuración de la página para el evento.");
            // Obtener y mostrar el nombre del evento
            const eventRef = doc(db, 'events', eventId);
            try {
                const eventSnap = await getDoc(eventRef);
                if (eventSnap.exists()) {
                    eventNameHeader.textContent = eventSnap.data().name;
                    console.log("setupPageForEvent: Nombre del evento cargado:", eventSnap.data().name);
                } else {
                    eventNameHeader.textContent = "Evento no encontrado";
                    showMessageModal('Error', 'El evento especificado no fue encontrado.', 'error');
                    console.warn("setupPageForEvent: Evento no encontrado para ID:", eventId);
                }
            } catch (error) {
                console.error("setupPageForEvent: Error al obtener el nombre del evento:", error);
                eventNameHeader.textContent = "Error al cargar el evento";
                showMessageModal('Error de Carga', 'No se pudo cargar la información del evento.', 'error');
            }

            // Configurar la colección de invitados para este evento
            guestsCollection = collection(db, 'events', eventId, 'guests');
            console.log("setupPageForEvent: Colección de invitados configurada:", `events/${eventId}/guests`);
            listenForGuests();

            // Solo inicializar html5QrCode si no existe ya
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
                console.log("setupPageForEvent: Nueva instancia de Html5Qrcode creada.");
            } else {
                console.log("setupPageForEvent: Html5Qrcode ya instanciado.");
            }
            
            startScanBtn.addEventListener('click', startQrScanner);
            stopScanBtn.addEventListener('click', stopQrScanner);
            
            // Listeners para los nuevos botones de agregar invitado
            addGuestBeforeBtn.addEventListener('click', () => addNewGuest('before'));
            addGuestAfterBtn.addEventListener('click', () => addNewGuest('after'));

            // Listener delegado para los botones de eliminar en la lista de invitados añadidos
            addedGuestsList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-guest-btn')) { // Usar closest para asegurar que se captura el botón
                    const button = e.target.closest('.delete-guest-btn');
                    const guestIdToDelete = button.dataset.id;
                    const guestNameToDelete = button.dataset.name;
                    // No hay cartel de confirmación
                    deleteGuest(guestIdToDelete);
                }
            });

            console.log("setupPageForEvent: Escáner QR inicializado y listeners de botones configurados.");
        }

        function listenForGuests() {
            console.log("listenForGuests: Iniciando listener de onSnapshot para invitados.");
            if (!guestsCollection) {
                console.error("listenForGuests: guestsCollection no está definido. No se puede iniciar el listener.");
                loadingState.style.display = 'none';
                guestListContainer.innerHTML = `<div class="text-center py-20 text-red-500">Error interno: La colección de invitados no está configurada.</div>`;
                showMessageModal('Error Interno', 'La aplicación no pudo configurar la colección de invitados. Recarga la página.', 'error');
                return;
            }

            onSnapshot(query(guestsCollection), (snapshot) => {
                console.log("onSnapshot: Datos recibidos. Cantidad de documentos:", snapshot.docs.length);
                loadingState.style.display = 'none';
                allGuests = [];
                if (snapshot.empty) {
                    console.log("onSnapshot: La colección de invitados está vacía.");
                    emptyStateRecepcion.style.display = 'block'; // Mostrar el estado vacío
                } else {
                    emptyStateRecepcion.style.display = 'none'; // Ocultar el estado vacío
                }
                snapshot.forEach(doc => {
                    allGuests.push({ id: doc.id, ...doc.data() });
                });
                allGuests.sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                updateCounters();
                filterAndRenderGuests();
                console.log("onSnapshot: Invitados procesados y renderizados.");
            }, (error) => {
                console.error("listenForGuests: Error en el listener de onSnapshot:", error);
                guestListContainer.innerHTML = `<div class="text-center py-20 text-red-500">Error al cargar la lista: ${error.message}. Verifica tus reglas de seguridad de Firestore.</div>`;
                showMessageModal('Error de Carga', `No se pudo cargar la lista de invitados: ${error.message}. Por favor, verifica tus reglas de seguridad de Firestore.`, 'error');
            });
        }
        
        function updateCounters() {
            console.log("updateCounters: Actualizando contadores.");
            const totalCount = allGuests.length;
            const presentCount = allGuests.filter(g => g.presente).length;
            const absentCount = totalCount - presentCount;
            const addedGuestsTotal = allGuests.filter(g => g.addedManually).length; // Contar solo invitados añadidos manualmente

            totalGuestsEl.textContent = totalCount;
            presentGuestsEl.textContent = presentCount;
            absentGuestsEl.textContent = absentCount;
            addedGuestsCountEl.textContent = addedGuestsTotal; // Actualizar contador de invitados añadidos

            // Mostrar u ocultar el mensaje de "no hay añadidos"
            if (addedGuestsTotal > 0) {
                emptyAddedGuestsState.classList.add('hidden');
            } else {
                emptyAddedGuestsState.classList.remove('hidden');
            }

            console.log(`Contadores: Total: ${totalCount}, Presentes: ${presentCount}, Ausentes: ${absentCount}, Añadidos: ${addedGuestsTotal}`);
        }

        function filterAndRenderGuests() {
            console.log("filterAndRenderGuests: Filtrando y renderizando invitados.");
            const searchTerm = searchInput.value.toLowerCase();
            
            // Separar invitados de la lista principal y los añadidos manualmente
            const mainGuests = allGuests.filter(guest => !guest.addedManually);
            const addedGuests = allGuests.filter(guest => guest.addedManually);

            const filteredMainGuests = mainGuests.filter(guest => 
                guest.nombre.toLowerCase().includes(searchTerm)
            );
            const filteredAddedGuests = addedGuests.filter(guest => 
                guest.nombre.toLowerCase().includes(searchTerm)
            );

            guestListContainer.innerHTML = '';
            addedGuestsList.innerHTML = ''; // Limpiar la lista de invitados añadidos manualmente

            // Renderizar lista principal
            if (filteredMainGuests.length === 0 && mainGuests.length > 0) {
                noResultsState.style.display = 'block';
                console.log("filterAndRenderGuests: No se encontraron resultados para el término de búsqueda en la lista principal.");
            } else {
                 noResultsState.style.display = 'none';
            }
            
            if (filteredMainGuests.length > 0) {
                emptyStateRecepcion.style.display = 'none'; 
            }

            filteredMainGuests.forEach(guest => {
                const guestCard = createGuestCard(guest);
                guestListContainer.appendChild(guestCard);
            });
            console.log(`filterAndRenderGuests: Renderizados ${filteredMainGuests.length} invitados principales.`);

            // Renderizar lista de invitados añadidos
            if (filteredAddedGuests.length > 0) {
                emptyAddedGuestsState.classList.add('hidden'); // Ocultar mensaje de vacío
                filteredAddedGuests.forEach(guest => {
                    const guestCard = createGuestCard(guest); // Reutilizar la función para la tarjeta
                    addedGuestsList.appendChild(guestCard);
                });
            } else {
                emptyAddedGuestsState.classList.remove('hidden'); // Mostrar mensaje de vacío
            }
            console.log(`filterAndRenderGuests: Renderizados ${filteredAddedGuests.length} invitados añadidos.`);
        }

        function createGuestCard(guest) {
            const guestCard = document.createElement('div');
            guestCard.className = `bg-white p-4 rounded-lg shadow-sm flex items-center justify-between transition-all duration-300 ${guest.presente ? 'bg-green-100 border-l-4 border-green-500' : ''}`;
            
            let timeInfoHtml = '';
            let deleteButtonHtml = '';
            let guestDetailsHtml = '';
            let checkboxHtml = '';

            if (guest.addedManually) {
                const timeText = guest.timeCategory === 'before' ? 'Antes 00:00' : 'Después 00:00';
                timeInfoHtml = `<span class="text-xs text-indigo-500">(${timeText})</span>`;
                deleteButtonHtml = `
                    <button class="delete-guest-btn" data-id="${guest.id}" data-name="${guest.nombre}" title="Eliminar invitado extra">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                // Para invitados añadidos manualmente:
                guestDetailsHtml = `
                    <p class="font-semibold text-gray-800">${guest.nombre}</p>
                    <p class="text-sm text-gray-500">Invitado extra ${timeInfoHtml}</p>
                `;
            } else {
                // Para invitados de la lista principal:
                guestDetailsHtml = `
                    <p class="font-semibold text-gray-800">${guest.nombre}</p>
                    <p class="text-sm text-gray-500">Mesa: ${guest.mesa || 'N/A'}</p>
                `;
                checkboxHtml = `
                    <input 
                        id="check-${guest.id}" 
                        type="checkbox" 
                        data-id="${guest.id}"
                        class="custom-checkbox h-6 w-6 rounded text-indigo-600 border-gray-300 focus:ring-2 focus:ring-indigo-500 cursor-pointer"
                        ${guest.presente ? 'checked' : ''}
                    >
                `;
            }

            guestCard.innerHTML = `
                <div class="flex-grow">
                    ${guestDetailsHtml}
                </div>
                <div class="flex items-center gap-2">
                    ${deleteButtonHtml}
                    ${checkboxHtml}
                </div>
            `;
            return guestCard;
        }


        searchInput.addEventListener('input', filterAndRenderGuests);

        // Listener unificado para cambios en checkboxes y radio buttons
        document.addEventListener('change', async (e) => {
            if (e.target.type === 'checkbox' && e.target.dataset.id) {
                const guestId = e.target.dataset.id;
                const isPresent = e.target.checked;
                
                const guestRef = doc(guestsCollection, guestId);
                try {
                    await updateDoc(guestRef, {
                        presente: isPresent
                    });
                    // La UI se actualizará automáticamente vía onSnapshot
                } catch (error) {
                    console.error("Error al actualizar asistencia manualmente: ", error);
                    showMessageModal('Error al Actualizar', 'No se pudo actualizar la asistencia manualmente. Inténtalo de nuevo.', 'error');
                    e.target.checked = !isPresent; // Revertir el estado del checkbox
                }
            }
            // No hay radio buttons para timeCategory en este diseño, la categoría se establece al añadir
        });

        // --- FUNCIONES PARA AÑADIR INVITADOS MANUALMENTE ---
        async function addNewGuest(timeCategory) { // 'before' o 'after'
            const guestName = newGuestNameInput.value.trim();

            if (!guestName) {
                showMessageModal('Campo Requerido', 'Por favor, introduce el nombre y apellido del invitado.', 'info');
                return;
            }

            if (!eventId) {
                showMessageModal('Error Interno', 'No se ha cargado un ID de evento. Recarga la página.', 'error');
                return;
            }

            try {
                // Añadir el nuevo invitado a Firestore
                const docRef = await addDoc(collection(db, 'events', eventId, 'guests'), {
                    nombre: guestName,
                    mesa: 'N/A (Agregado)', // Opcional: indicar que es un invitado manual sin mesa asignada
                    presente: true, // Se asume que al agregarlo, ya está presente
                    addedManually: true, // Marca que fue añadido manualmente
                    timeCategory: timeCategory, // 'before' o 'after'
                    timestamp: new Date() // Para mantener un registro del momento de adición
                });
                console.log("Nuevo invitado añadido con ID: ", docRef.id);

                // COMENTADO: showMessageModal('Invitado Agregado', `${guestName} (${timeCategory === 'before' ? 'Antes 00:00' : 'Después 00:00'}) ha sido añadido y marcado como presente.`, 'success');
                newGuestNameInput.value = ''; // Limpiar campo de nombre
                // La lista se actualizará automáticamente a través de onSnapshot
            } catch (e) {
                console.error("Error al añadir invitado: ", e);
                showMessageModal('Error al Añadir', `No se pudo añadir el invitado: ${e.message}.`, 'error');
            }
        }

        // --- FUNCION PARA ELIMINAR INVITADOS AÑADIDOS MANUALMENTE ---
        async function deleteGuest(guestId) {
            console.log("Intentando eliminar invitado con ID:", guestId); // Depuración
            if (!eventId) {
                showMessageModal('Error Interno', 'No se ha cargado un ID de evento. Recarga la página.', 'error');
                return;
            }

            try {
                const guestRef = doc(db, 'events', eventId, 'guests', guestId);
                await deleteDoc(guestRef);
                console.log("Invitado eliminado con ID:", guestId);
                // COMENTADO: showMessageModal('Invitado Eliminado', 'El invitado extra ha sido eliminado correctamente.', 'success');
                // La UI se actualizará automáticamente vía onSnapshot
            } catch (e) {
                console.error("Error al eliminar invitado: ", e);
                showMessageModal('Error al Eliminar', `No se pudo eliminar el invitado: ${e.message}.`, 'error');
            }
        }

        // --- FUNCIONES DEL ESCÁNER QR ---
        async function startQrScanner() {
            console.log("startQrScanner: Intentando iniciar escáner QR.");
            qrReaderResultsElement.textContent = 'Iniciando escáner...';
            startScanBtn.classList.add('hidden');
            stopScanBtn.classList.remove('hidden');

            // Reanudar AudioContext al iniciar el escáner (interacción del usuario)
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    console.log("AudioContext reanudado al iniciar escáner.");
                } catch (e) {
                    console.error("Error al reanudar AudioContext al iniciar escáner:", e);
                    // No bloquear la cámara si el audio falla
                }
            }

            // Verificar si el protocolo es HTTPS o localhost
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                const errorMessage = 'La cámara solo funciona en un entorno seguro (HTTPS) o en localhost. Estás usando: ' + window.location.protocol;
                console.error("startQrScanner:", errorMessage);
                qrReaderResultsElement.textContent = errorMessage;
                showMessageModal('Error de Cámara', errorMessage, 'error');
                startScanBtn.classList.remove('hidden');
                stopScanBtn.classList.add('hidden');
                return;
            }

            // Verificar la disponibilidad de la API de medios
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const errorMessage = 'Tu navegador no soporta el acceso a la cámara (getUserMedia). Por favor, actualiza tu navegador.';
                console.error("startQrScanner:", errorMessage);
                showMessageModal('Error de Cámara', errorMessage, 'error');
                startScanBtn.classList.remove('hidden');
                stopScanBtn.classList.add('hidden');
                return;
            }
            
            // Enumerar dispositivos de video para depuración
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log("Dispositivos de video detectados:", videoDevices);
                if (videoDevices.length === 0) {
                    console.warn("No se encontraron dispositivos de video (cámaras).");
                    showMessageModal('Error de Cámara', 'No se encontraron cámaras disponibles en este dispositivo.', 'error');
                    startScanBtn.classList.remove('hidden');
                    stopScanBtn.classList.add('hidden');
                    return;
                }
            } catch (enumError) {
                console.error("Error al enumerar dispositivos de medios:", enumError);
                showMessageModal('Error de Cámara', 'No se pudo acceder a la lista de cámaras. Asegúrate de permitir el acceso.', 'error');
                startScanBtn.classList.remove('hidden');
                stopScanBtn.classList.add('hidden');
                return;
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            try {
                // Asegurarse de que html5QrCode esté inicializado
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                    console.log("startQrScanner: Html5Qrcode instanciado justo antes de iniciar.");
                }
                await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
                qrReaderResultsElement.textContent = 'Escáner iniciado. Apunta la cámara al QR.';
                console.log("startScanBtn: Escáner QR iniciado exitosamente.");
            } catch (err) {
                console.error("startScanBtn: Error al iniciar el escáner QR:", err);
                let errorMessage = 'Error al iniciar el escáner. Asegúrate de permitir el acceso a la cámara y que no esté en uso por otra aplicación.';
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    errorMessage += ' (Requiere HTTPS para el acceso a la cámara).';
                }
                qrReaderResultsElement.textContent = errorMessage;
                showMessageModal('Error de Cámara', errorMessage, 'error');
            } finally {
                // Asegurar que los botones se restablezcan a su estado correcto
                startScanBtn.classList.add('hidden'); // Ocultar iniciar
                stopScanBtn.classList.remove('hidden'); // Mostrar detener
            }
        }

        async function stopQrScanner() {
            console.log("stopQrScanner: Intentando detener escáner QR.");
            if (!html5QrCode) {
                console.log("stopQrScanner: html5QrCode no está inicializado, no hay nada que detener.");
                return;
            }

            try {
                if (html5QrCode.isScanning || isScannerPausedForFeedback) { // Si está escaneando o pausado por feedback
                    await html5QrCode.stop();
                    console.log("stopQrScanner: Escáner QR detenido exitosamente.");
                } else {
                    console.log("stopQrScanner: Escáner no estaba activo o ya detenido.");
                }
                // Limpiar el contenido del lector QR para que no se muestre el último frame
                qrReaderElement.innerHTML = ''; 
                qrReaderResultsElement.textContent = 'Escáner detenido.';
                startScanBtn.classList.remove('hidden');
                stopScanBtn.classList.add('hidden');
                hideFullScreenFeedback(); // Asegurarse de ocultar el feedback de pantalla completa
                isScannerPausedForFeedback = false; // Resetear el flag
            } catch (err) {
                console.error("stopQrScanner: Error al detener el escáner QR:", err);
                qrReaderResultsElement.textContent = 'Error al detener el escáner.';
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`onScanSuccess: QR detectado: ${decodedText}`);
            
            // Debounce: Si el mismo QR fue escaneado recientemente, ignorarlo.
            // Esto es un debounce rápido para evitar múltiples triggers si el QR se mantiene.
            if (lastScannedGuestId === decodedText) {
                console.log("onScanSuccess: QR duplicado detectado, ignorando.");
                return;
            }
            lastScannedGuestId = decodedText;
            // Resetear lastScannedGuestId después de un breve período para permitir re-escaneos
            setTimeout(() => { lastScannedGuestId = null; }, 1000); // 1 segundo de debounce

            try {
                const qrData = JSON.parse(decodedText);
                const scannedEventId = qrData.eventId;
                const scannedGuestId = qrData.guestId;

                console.log(`onScanSuccess: Datos del QR - eventId: ${scannedEventId}, guestId: ${scannedGuestId}`);
                console.log(`onScanSuccess: eventId actual de la página: ${eventId}`);

                if (scannedEventId !== eventId) {
                    showScanFeedback('Este QR es de otro evento.', 'error'); // Mensaje pequeño para errores
                    playFeedbackSound('error'); // Sonido para error de QR
                    console.warn("onScanSuccess: Mismatch de eventId. QR de otro evento.");
                    return; // No procesar si el evento no coincide
                }

                // Buscar solo en los invitados NO añadidos manualmente para QR codes
                const guestToUpdate = allGuests.find(g => g.id === scannedGuestId && !g.addedManually);
                console.log("onScanSuccess: Invitado encontrado para actualizar (no manual):", guestToUpdate);

                if (guestToUpdate) {
                    if (guestToUpdate.presente) {
                        showScanFeedback(`¡${guestToUpdate.nombre} ya está presente! (Mesa: ${guestToUpdate.mesa})`, 'info'); // Mensaje pequeño para ya presente
                        playFeedbackSound('info'); // Sonido para invitado ya presente
                        console.log(`onScanSuccess: Invitado ${guestToUpdate.nombre} ya estaba presente.`);
                    } else {
                        // Escaneo exitoso y actualización: Pausar escáner y mostrar feedback en pantalla completa
                        if (html5QrCode && html5QrCode.isScanning) {
                            await html5QrCode.pause(); // Pausar el escáner
                            isScannerPausedForFeedback = true; // Establecer flag
                            console.log("Escáner pausado para feedback en pantalla completa.");
                        }

                        const guestRef = doc(guestsCollection, scannedGuestId);
                        await updateDoc(guestRef, { presente: true });
                        // Mensaje en pantalla completa con nombre y mesa
                        displayFullScreenFeedback(`${guestToUpdate.nombre}<br><span>Mesa: ${guestToUpdate.mesa}</span>`, 'success');
                        playFeedbackSound('success'); // Sonido para registro exitoso
                        console.log(`onScanSuccess: Invitado ${guestToUpdate.nombre} marcado como presente. Mostrando feedback en pantalla completa.`);
                    }
                } else {
                    showScanFeedback('Invitado no encontrado en la lista principal o es un invitado añadido manualmente.', 'error'); // Mensaje más específico
                    playFeedbackSound('error'); // Sonido para invitado no encontrado
                    console.warn("onScanSuccess: Invitado no encontrado en la lista principal (posiblemente un invitado añadido manualmente o ID incorrecto).");
                }
            } catch (e) {
                console.error("onScanSuccess: Error al procesar QR:", e);
                showScanFeedback('Error al leer QR. Formato inválido.', 'error'); // Mensaje pequeño para errores de parseo
                playFeedbackSound('error'); // Sonido para error de lectura de QR
            }
            // La cámara permanece abierta o es pausada/reanudada por displayFullScreenFeedback
        }

        function onScanError(errorMessage) {
            // console.warn(`onScanError: ${errorMessage}`);
            // No mostrar errores de escaneo constantemente para evitar sobrecargar la UI
        }
    </script>
</body>
</html>